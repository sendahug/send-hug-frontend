version: 2.1
orbs:
  browser-tools: circleci/browser-tools@1.4.8
  cypress: cypress-io/cypress@3.3.1
  codecov: codecov/codecov@4.1.0
jobs:
  format:
    docker:
      - image: cimg/node:lts
    resource_class: medium
    steps:
      - checkout
      - restore_cache:
          key: send-hug-v1-
      - run: npm install
      - save_cache:
          key: send-hug-v1-{{ checksum "package-lock.json" }}
          paths:
            - "node_modules"
      - run: npx prettier --check .
  test:
    docker:
      - image: cimg/node:lts
    resource_class: medium
    environment:
      CHROME_BIN: /usr/bin/google-chrome
      CHROME_PATH: /usr/bin/google-chrome
    steps:
      - checkout
      - run:
          name: install dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y libgbm1
            sudo apt-get update &&\
                sudo apt-get install -yq gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 \
                libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 \
                libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 \
                libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 \
                ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget \
                xvfb x11vnc x11-xkb-utils xfonts-100dpi xfonts-75dpi xfonts-scalable xfonts-cyrillic x11-apps
      - restore_cache:
          key: send-hug-v1-
      - run: npm install
      - save_cache:
          key: send-hug-v1-{{ checksum "package-lock.json" }}
          paths:
            - "node_modules"
      - run: npx playwright install --with-deps
      - run: npm test
      - codecov/upload
  e2e:
    docker:
      - image: cimg/python:3.11-node
        environment:
          BASE_DATABASE_URL: postgresql://postgres:password@localhost:5432/sendahug
          QUART_APP: send-hug-backend/app.py:app
          FLASK_ENV: development
          FRONTEND: http://localhost:3000
          FIREBASE_CREDENTIALS_FILE: send-hug-backend/test_creds.json
      - image: cimg/postgres:14.10
        environment:
          POSTGRES_USER: postgres
          POSTGRES_DB: sendahug
          POSTGRES_PASSWORD: password
    resource_class: medium
    environment:
      CHROME_BIN: /usr/bin/google-chrome
    steps:
      - checkout
      - run: |
          sudo npm install -g pa11y-ci --unsafe-perm=true --allow-root
          sudo apt-get update
          sudo apt-get install -y postgresql-client python3-pip xvfb
      - run: |
          cd ..
          git clone https://github.com/sendahug/send-hug-backend
      - run:
          name: Install Python deps
          command: |
            cd ..
            pip3 install -r send-hug-backend/requirements.txt
            python3 -m pip install --upgrade pip
      # Dockerize installation to wait for the database to load
      # Taken from: https://support.circleci.com/hc/en-us/articles/360006773953-Race-Conditions-Wait-For-Database
      - run:
          name: Wait for db
          command: dockerize -wait tcp://localhost:5432 -timeout 1m
      - run: psql -d $BASE_DATABASE_URL -c "CREATE ROLE circleci WITH SUPERUSER LOGIN;"
      - run:
          name: Restore database
          command: |
            mv e2e/setup.py ../send-hug-backend
            echo "$FIREBASE_TEST_ACCT_KEY" > ../send-hug-backend/test_creds.json
            cd ../send-hug-backend
            python3 setup.py
      - run:
          name: Start backend
          command: |
            cd ..
            quart run
          background: true
      - browser-tools/install-browser-tools
      - run: google-chrome --version
      - cypress/install
      - restore_cache:
          key: send-hug-v1-
      - run:
          name: Install dependencies
          command: npm install
      - save_cache:
          key: send-hug-v1-{{ checksum "package-lock.json" }}
          paths:
            - "node_modules"
      - run:
          name: Start frontend server
          command: npm run dev
          background: true
      - run:
          name: Run e2e tests
          command: npm run cypress
      - store_artifacts:
          path: /home/circleci/project/cypress
          destination: cypress-screenshots
  accessibility:
    docker:
      - image: cimg/python:3.11-node
        environment:
          BASE_DATABASE_URL: postgresql://postgres:password@localhost:5432/sendahug
          QUART_APP: send-hug-backend/app.py:app
          FLASK_ENV: development
          FRONTEND: http://localhost:3000
          FIREBASE_CREDENTIALS_FILE: send-hug-backend/test_creds.json
      - image: cimg/postgres:14.10
        auth:
          username: mydockerhub-user
          password: $DOCKERHUB_PASSWORD # context / project UI env-var reference
        environment:
          POSTGRES_USER: postgres
          POSTGRES_DB: sendahug
          POSTGRES_PASSWORD: password
    resource_class: medium
    environment:
      CHROME_BIN: /usr/bin/google-chrome
    steps:
      - checkout
      - run: |
          sudo npm install -g pa11y-ci --unsafe-perm=true --allow-root
          sudo apt-get update
          sudo apt-get install -y postgresql-client python3-pip xvfb
      - run: |
          cd ..
          git clone https://github.com/sendahug/send-hug-backend
      - run:
          name: Install Python deps
          command: |
            cd ..
            pip3 install -r send-hug-backend/requirements.txt
            python3 -m pip install --upgrade pip
      # Dockerize installation to wait for the database to load
      # Taken from: https://support.circleci.com/hc/en-us/articles/360006773953-Race-Conditions-Wait-For-Database
      - run:
          name: Wait for db
          command: dockerize -wait tcp://localhost:5432 -timeout 1m
      - run: psql -d $BASE_DATABASE_URL -c "CREATE ROLE circleci WITH SUPERUSER LOGIN;"
      - run:
          name: Restore database
          command: |
            mv e2e/setup.py ../send-hug-backend
            echo "$FIREBASE_TEST_ACCT_KEY" > ../send-hug-backend/test_creds.json
            cd ../send-hug-backend
            python3 setup.py
      - run:
          name: Start backend
          command: |
            cd ..
            quart run
          background: true
      - browser-tools/install-browser-tools
      - run: google-chrome --version
      - restore_cache:
          key: send-hug-v1-
      - run:
          name: Install dependencies
          command: npm install
      - save_cache:
          key: send-hug-v1-{{ checksum "package-lock.json" }}
          paths:
            - "node_modules"
      - run:
          name: Start frontend server
          command: npm run dev
          background: true
      - run: sleep 15
      - run:
          name: Run accessibility tests
          command: pa11y-ci --sitemap http://localhost:3000/sitemap.xml --config .pa11yci

workflows:
  run-testing:
    jobs:
      - format
      - test
      - e2e
      - accessibility
